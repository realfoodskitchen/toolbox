Connect-MgGraph -Scopes `
    "DeviceManagementManagedDevices.Read.All", `
    "DeviceManagementApps.Read.All"

$devices = Get-MgDeviceManagementManagedDevice -All

# CSV output file
$csvPath = ".\PerDevice_ManagedApps_Report.csv"
"DeviceName,UserPrincipalName,AppName,AppVersion,InstallState,Publisher" | Out-File -FilePath $csvPath -Encoding UTF8

# Loop through devices
foreach ($device in $devices) {
    Write-Host "Processing $($device.DeviceName)" -ForegroundColor Cyan

    $uri = "https://graph.microsoft.com/v1.0/deviceManagement/managedDevices/$($device.Id)/managedApps"

    try {
        $appsResponse = Invoke-MgGraphRequest -Method GET -Uri $uri
        $apps = $appsResponse.value
    } catch {
        Write-Warning "Error fetching apps for $($device.DeviceName): $_"
        continue
    }

    foreach ($app in $apps) {
        "$($device.DeviceName),$($device.UserPrincipalName),$($app.DisplayName),$($app.Version),$($app.InstallState),$($app.Publisher)" |
            Out-File -FilePath $csvPath -Append -Encoding UTF8
    }
}