Connect-MgGraph -Scopes `
    "DeviceManagementManagedDevices.Read.All", `
    "DeviceManagementApps.Read.All", `
    "DeviceManagementConfiguration.Read.All"

# Output folders
$masterCsv = ".\All_Devices_AppInventory.csv"
$deviceCsvFolder = ".\PerDeviceReports"

# Create the folder if it doesn't exist
if (-not (Test-Path $deviceCsvFolder)) {
    New-Item -Path $deviceCsvFolder -ItemType Directory | Out-Null
}

# Call the devicesByAppINV report
$response = Invoke-MgGraphRequest -Method POST -Uri "https://graph.microsoft.com/beta/deviceManagement/reports/devicesByAppINV"

# Convert CSV text to PowerShell objects
$appInventory = $response | ConvertFrom-Csv

# Save master report
$appInventory | Export-Csv -Path $masterCsv -NoTypeInformation -Encoding UTF8
Write-Host "Master inventory saved: $masterCsv" -ForegroundColor Green

# Group by device and export per-device CSVs
$appInventory | Group-Object DeviceName | ForEach-Object {
    $deviceName = $_.Name -replace '[\\/:*?"<>|]', '_'  # Sanitize file name
    $deviceFile = Join-Path $deviceCsvFolder "$deviceName.csv"

    $_.Group | Export-Csv -Path $deviceFile -NoTypeInformation -Encoding UTF8
    Write-Host "Device report saved: $deviceFile"
}

Write-Host "`nAll done! Per-device reports exported to: $deviceCsvFolder" -ForegroundColor Cyan

